POSTGRES CONNECTION & API GUIDE
================================

POSTGRES DIRECT CONNECTION
---------------------------
Host:     127.0.0.1
Port:     5432
User:     postgres (default, or set POSTGRES_USER env var)
Password: superadmin (default, or set POSTGRES_PASSWORD env var)
Database: postgres

Connection String:
  postgres://postgres:superadmin@127.0.0.1:5432/postgres?sslmode=disable

Example psql command:
  psql -h 127.0.0.1 -p 5432 -U postgres -d postgres

Example with password:
  PGPASSWORD=superadmin psql -h 127.0.0.1 -p 5432 -U postgres -d postgres


DYNAMIC DATABASE CREATION VIA API
----------------------------------
All API requests go through nginx on port 8010.

1. GET ADMIN KEY
   The admin key is generated at container startup and logged.
   To get it, check golang container logs:
   
   docker logs golang | grep "ADMIN KEY"
   
   Or:
   docker logs golang
   
   Look for line: "ðŸ”‘ ADMIN KEY: sk_..."

2. HEALTH CHECK
   curl http://localhost:8010/health
   
   Expected response:
   {"status":"ok"}

3. CREATE NEW DATABASE
   POST http://localhost:8010/provision
   
   Headers:
   Content-Type: application/json
   
   Body:
   {
     "app_name": "myapp",
     "admin_key": "sk_YOUR_ADMIN_KEY_HERE"
   }
   
   Example curl:
   curl -X POST http://localhost:8010/provision \
     -H "Content-Type: application/json" \
     -d '{
       "app_name": "myapp",
       "admin_key": "sk_YOUR_ADMIN_KEY_HERE"
     }'
   
   Success response (201):
   {
     "connection_string": "postgres://app_myapp_user:PASSWORD@postgres:5432/app_myapp?sslmode=disable"
   }
   
   Error responses:
   - 400: Invalid app_name format (must be 3-32 chars, lowercase alphanumeric + underscore)
   - 401: Invalid admin key
   - 409: App already exists
   - 500: Server error

4. APP NAME RULES
   - 3-32 characters
   - Lowercase letters, numbers, and underscores only
   - Examples: "myapp", "app1", "test_app", "my_service"

5. CREATED DATABASE DETAILS
   Database name: app_{app_name}
   Username:      app_{app_name}_user
   Password:      Randomly generated (returned in connection_string)
   Owner:         app_{app_name}_user
   Permissions:   Full access to the database, no superuser privileges


COMPLETE EXAMPLE WORKFLOW
--------------------------
# 1. Get admin key
ADMIN_KEY=$(docker logs golang 2>&1 | grep "ADMIN KEY" | awk '{print $NF}')

# 2. Check health
curl http://localhost:8010/health

# 3. Create database for "myapp"
curl -X POST http://localhost:8010/provision \
  -H "Content-Type: application/json" \
  -d "{
    \"app_name\": \"myapp\",
    \"admin_key\": \"$ADMIN_KEY\"
  }"

# 4. Response will contain connection_string like:
# postgres://app_myapp_user:RandomPassword123@postgres:5432/app_myapp?sslmode=disable


NOTES
-----
- Admin key changes on every container restart
- Connection strings use "postgres" as hostname (for container network)
- For external connections, use 127.0.0.1:5432
- All created databases are isolated with their own users
- Each app gets its own database and user with full privileges on that database only
